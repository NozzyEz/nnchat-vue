(function(t){function e(e){for(var a,c,r=e[0],i=e[1],l=e[2],h=0,u=[];h<r.length;h++)c=r[h],Object.prototype.hasOwnProperty.call(o,c)&&o[c]&&u.push(o[c][0]),o[c]=0;for(a in i)Object.prototype.hasOwnProperty.call(i,a)&&(t[a]=i[a]);d&&d(e);while(u.length)u.shift()();return n.push.apply(n,l||[]),s()}function s(){for(var t,e=0;e<n.length;e++){for(var s=n[e],a=!0,r=1;r<s.length;r++){var i=s[r];0!==o[i]&&(a=!1)}a&&(n.splice(e--,1),t=c(c.s=s[0]))}return t}var a={},o={app:0},n=[];function c(e){if(a[e])return a[e].exports;var s=a[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,c),s.l=!0,s.exports}c.m=t,c.c=a,c.d=function(t,e,s){c.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},c.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},c.t=function(t,e){if(1&e&&(t=c(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(c.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)c.d(s,a,function(e){return t[e]}.bind(null,a));return s},c.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return c.d(e,"a",e),e},c.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},c.p="/nnchat-vue/";var r=window["webpackJsonp"]=window["webpackJsonp"]||[],i=r.push.bind(r);r.push=e,r=r.slice();for(var l=0;l<r.length;l++)e(r[l]);var d=i;n.push([1,"chunk-vendors"]),s()})({0:function(t,e){},"034f":function(t,e,s){"use strict";var a=s("85ec"),o=s.n(a);o.a},"03b3":function(t,e,s){},"0f7d":function(t,e,s){"use strict";s.r(e);var a=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"message-wrapper row no-select",class:[t.message.received?"start-xs":"end-xs"]},[s("div",{staticClass:"message",class:[t.message.received?"received":"sent"]},[t._v(" "+t._s(t.message.content)+" ")])])},o=[],n={props:["message"]},c=n,r=(s("564b"),s("2877")),i=Object(r["a"])(c,a,o,!1,null,"af735c6a",null);e["default"]=i.exports},1:function(t,e,s){t.exports=s("56d7")},"107c":function(t,e,s){"use strict";s.r(e);var a=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"conversation full-height"},[s("div",{staticClass:"user-wrapper row middle-xs no-select"},["sm"===t.$mq?s("div",{staticClass:"col-xs-1",on:{click:function(e){t.$store.state.contactsVisible=!0}}},[t._v(" ☰ ")]):t._e(),t.chatSelected?s("div",{staticClass:"col-xs"},[t._v(" "+t._s(t.$store.state.contacts[t.$store.state.selectedChat].name)+" ")]):t._e(),t.$store.state.canConnect?t._e():s("div",{staticClass:"col-xs end-xs error"},[t._v(" Connection lost ")])]),s("div",{staticClass:"messages-wrapper"},[t.chatSelected?s("messages",{attrs:{chat:t.$store.state.chats[t.$store.state.selectedChat]}}):t._e()],1),s("div",{staticClass:"input-wrapper row middle-xs"},[s("div",{staticClass:"col-xs"},[s("input",{directives:[{name:"model",rawName:"v-model",value:t.message,expression:"message"}],staticClass:"input-field",attrs:{type:"text"},domProps:{value:t.message},on:{keydown:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.sendMessage(e)},input:function(e){e.target.composing||(t.message=e.target.value)}}})])])])},o=[],n={data(){return{message:""}},computed:{chatSelected(){return null!=this.$store.state.selectedChat&&this.$store.state.contacts.hasOwnProperty(this.$store.state.selectedChat)}},methods:{sendMessage(){if(0==this.message.length||null==this.$store.state.selectedChat)return;this.$store.state.chats[this.$store.state.selectedChat].push({received:!1,content:this.message}),this.$idbSet("chats",this.$store.state.chats).then(()=>{let t=document.getElementById("messages");t.scrollTop=t.scrollHeight});let t=this.encryptMsg(this.message);this.postMessage(t,this.$store.state.selectedChat),this.message=""},postMessage(t,e){let s={headers:{Authorization:"Bearer "+this.$store.state.credentials.accessToken}};this.$http.post(this.$store.state.apiURL+"send/",{receiver:e,message:t},s).then(t=>{console.log("message sent."),console.log(t.body)},s=>{console.log(s),this.$store.dispatch("refreshToken").then(s=>{this.postMessage(t,e)},t=>{console.log("couldn't refresh token while sending message.")})})},generateKey(t){let e=this.$sha2(t),s=Uint8Array.from(e),a=[];for(let o=0;o<16;o++)a[o]=s[o];return a},encryptMsg(t){console.log(`original message: ${t}`);let e=this.generateKey(this.$store.state.contacts[this.$store.state.selectedChat].key),s=this.$aes.utils.utf8.toBytes(t),a=new this.$aes.ModeOfOperation.ctr(e,new this.$aes.Counter(5)),o=a.encrypt(s),n=this.$aes.utils.hex.fromBytes(o);return console.log(`encrypted: ${n}`),n}}},c=n,r=(s("29b2"),s("2877")),i=Object(r["a"])(c,a,o,!1,null,"6fd271e8",null);e["default"]=i.exports},"17d6":function(t,e,s){},"1cc2":function(t,e,s){"use strict";var a=s("d9fa"),o=s.n(a);o.a},2:function(t,e){},"284c":function(t,e,s){"use strict";s.r(e);var a=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"messages",attrs:{id:"messages"}},t._l(t.chat,(function(e,a){return s("message",{attrs:{message:e},nativeOn:{click:function(e){return t.deleteMessage(a)}}})})),1)},o=[],n={props:["chat"],methods:{deleteMessage(t){confirm("Delete this message?")&&(console.log("deleting message "+t),this.chat.splice(t,1))}}},c=n,r=(s("b056"),s("2877")),i=Object(r["a"])(c,a,o,!1,null,"26e23406",null);e["default"]=i.exports},"28d6":function(t,e,s){},"29b2":function(t,e,s){"use strict";var a=s("17d6"),o=s.n(a);o.a},3:function(t,e){},4:function(t,e){},"4eaf":function(t,e,s){},5:function(t,e){},"564b":function(t,e,s){"use strict";var a=s("4eaf"),o=s.n(a);o.a},"56d7":function(t,e,s){"use strict";s.r(e);var a=s("2b0e"),o=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{attrs:{id:"app"}},[s("router-view")],1)},n=[],c={created(){this.getStoredData(),this.$store.state.selectedChat=this.$cookies.get("selectedChat")},methods:{getStoredData(){this.$idbGet("chats").then(t=>{void 0===t?(console.log("stored chats not found..."),this.$idbSet("chats",{}).then(()=>{console.log("empty chats list created.")})):this.$store.state.chats=t}),this.$idbGet("contacts").then(t=>{void 0===t?(console.log("stored contacts not found..."),this.$idbSet("contacts",{}).then(()=>{console.log("empty contacts list created.")})):this.$store.state.contacts=t}),this.$idbGet("credentials").then(t=>{void 0===t?(console.log("stored credentials not found..."),this.generateCredentials()):(this.$store.state.credentials=t,console.log("starting to fetch messages..."),this.$options.interval=setInterval(this.getMessages,5e3))})},generateCredentials(){this.$store.state.credentials={id:this.$randomString.generate(150),password:this.$randomString.generate(30),secret:this.generateSecret(),lastReceived:0},console.log("new credentials generated."),this.register()},generateSecret(){let t=new Uint32Array(32),e=window.crypto.getRandomValues(t),s="";for(let a of e)s+=a;return s},register(){let t={username:this.$store.state.credentials.id,password:this.$store.state.credentials.password};this.$http.post(this.$store.state.apiURL+"auth/register/",t).then(t=>{t.body.hasOwnProperty("success")&&0==t.body.success?(console.log("user already exists, generating new credentials..."),this.generateCredentials()):t.body.refresh&&t.body.access?(this.$store.state.credentials.refreshToken=t.body.refresh,this.$store.state.credentials.accessToken=t.body.access,this.$idbSet("credentials",this.$store.state.credentials).then(()=>{console.log("new credentials stored."),console.log("starting to fetch messages..."),this.$options.interval=setInterval(this.getMessages,5e3)})):(console.log("tokens not received: "),console.log(t))},t=>{console.log("error:"),console.log(t)})},generateKey(t){let e=this.$sha2(t),s=Uint8Array.from(e),a=[];for(let o=0;o<16;o++)a[o]=s[o];return a},decryptMsg(t,e){let s=this.generateKey(this.$store.state.contacts[e].key),a=new this.$aes.ModeOfOperation.ctr(s,new this.$aes.Counter(5)),o=this.$aes.utils.hex.toBytes(t),n=a.decrypt(o),c=this.$aes.utils.utf8.fromBytes(n);return console.log(`Decrypted: ${c}`),c},getMessages(){let t={headers:{Authorization:"Bearer "+this.$store.state.credentials.accessToken}};this.$http.post(this.$store.state.apiURL+"receive/",{last_message_id:this.$store.state.credentials.lastReceived},t).then(t=>{if(this.$store.state.canConnect=!0,console.log(t.body.messages.length+" messages fetched"),console.log(t.body.messages),1==t.body.success&&0!=t.body.messages.length){for(let e of t.body.messages)if(this.$store.state.chats.hasOwnProperty(e.sender)){let t=this.decryptMsg(e.message,e.sender);this.$store.state.chats[e.sender].push({received:!0,content:t}),this.$store.state.contacts[e.sender].seen=e.sender==this.$store.state.selectedChat}this.$store.state.credentials.lastReceived=t.body.messages[t.body.messages.length-1].id}this.$idbSet("chats",this.$store.state.chats).then(()=>{let t=document.getElementById("messages");null!=t&&(t.scrollTop=t.scrollHeight),this.$idbSet("credentials",this.$store.state.credentials)})},t=>{console.log("error getting messages:"),"token_not_valid"==t.body.code?(console.log("Token expired."),this.$store.dispatch("refreshToken")):0==t.ok?(console.log("can't connect"),this.$store.state.canConnect=!1):console.log(t)})}}},r=c,i=(s("034f"),s("2877")),l=Object(i["a"])(r,o,n,!1,null,null,null),d=l.exports,h=s("8c4f"),u=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("div",{staticClass:"row"},[s("transition",{attrs:{"enter-active-class":"animated slideInLeft faster","leave-active-class":"animated slideOutLeft faster"}},[t.$store.state.contactsVisible||"lg"===t.$mq?s("div",{staticClass:"col-md-2 col-xs-12 chats borders"},[s("chats")],1):t._e()]),s("div",{staticClass:"col-md-8 col-xs-12 borders"},[s("conversation")],1),s("transition",{attrs:{"enter-active-class":"animated slideInRight faster","leave-active-class":"animated slideOutRight faster"}},[t.$store.state.addContactVisible?s("div",{staticClass:"col-md-2 col-xs-12 add-contact borders"},[s("add-contact")],1):t._e()])],1)])},g=[],p={},f=p,v=(s("1cc2"),Object(i["a"])(f,u,g,!1,null,"198784a4",null)),m=v.exports;a["a"].use(h["a"]);const $=[{path:"/",name:"frontpage",component:m}],b=new h["a"]({mode:"history",base:"/nnchat-vue/",routes:$});var y=b,C=s("2f62");a["a"].use(C["a"]);var w=new C["a"].Store({state:{addContactVisible:!1,contactsVisible:!1,selectedChat:null,contacts:{},chats:{},credentials:{},apiURL:"https://glacial-chamber-87753.herokuapp.com/api/",publicMod:"112457129983317064494133258034491756790943511028023366901014968560410379195027",canConnect:!0},actions:{refreshToken(){return new Promise((t,e)=>{let s={headers:{"Content-Type":"application/json"}};this._vm.$http.post(this.state.apiURL+"refresh/",{refresh:this.state.credentials.refreshToken},s).then(s=>{let a=s.body.access;null!=a?(console.log("new access token fetched..."),this.state.credentials.accessToken=a,this._vm.$idbSet("credentials",this.state.credentials).then(()=>{console.log("token saved."),t(s)})):(console.log("couldn't refresh token:"),console.log(s),e(s))}).catch(s=>{console.log("error while refreshing token:"),"token_not_valid"==s.body.code&&(console.log("refresh token expired."),this.dispatch("login").then(e=>{t(e)},t=>{e(t)}))})})},login(){return new Promise((t,e)=>{let s={username:this.state.credentials.id,password:this.state.credentials.password};this._vm.$http.post(this.state.apiURL+"token/",s).then(s=>{s.body.refresh&&s.body.access?(this.state.credentials.refreshToken=s.body.refresh,this.state.credentials.accessToken=s.body.access,this._vm.$idbSet("credentials",this.state.credentials).then(()=>{console.log("new tokens stored."),t(s)})):(console.log("tokens not received: "),console.log(s),e(s))},t=>{console.log("error while logging in:"),console.log(t),e(t)})})}}}),_=s("28dd"),x=(s("05cc"),s("660e")),k=s("6112"),O=s.n(k),S=s("9a3e"),M=s("7409"),j=s.n(M),P=s("4487"),D=s.n(P),T=s("5c1a"),N=s.n(T),R=s("7247"),E=s.n(R),A=s("ccc2"),U=s("ced0"),I=s("2b27"),V=s.n(I),L=s("5383"),B=s.n(L);V.a.config("7d"),a["a"].use(O.a),a["a"].use(S["default"]),a["a"].use(_["a"]),a["a"].use(V.a),a["a"].use(x["a"],{breakpoints:{sm:768,lg:1/0}}),Object.defineProperty(a["a"].prototype,"$bigInt",{value:j.a}),Object.defineProperty(a["a"].prototype,"$randomString",{value:D.a}),Object.defineProperty(a["a"].prototype,"$forge",{value:N.a}),Object.defineProperty(a["a"].prototype,"$aes",{value:E.a}),Object.defineProperty(a["a"].prototype,"$sha2",{value:A["sha512_256"]}),Object.defineProperty(a["a"].prototype,"$idbGet",{value:U["b"]}),Object.defineProperty(a["a"].prototype,"$idbSet",{value:U["c"]}),Object.defineProperty(a["a"].prototype,"$idbDel",{value:U["a"]}),a["a"].directive("long-press",B.a),a["a"].filter("date",(function(t){if(!t)return"";let e=["January","February","March","April","May","June","July","August","September","October","November","December"],s=t.toString().split(" ")[0].replace(/-/g,"/"),a=new Date(s);return e[a.getMonth()]+" "+a.getDate()+", "+a.getFullYear()})),a["a"].config.productionTip=!1;const W=s("6ae9");W.keys().forEach(t=>{a["a"].component(t.split("/").pop().split(".")[0],W(t).default||W(t))}),new a["a"]({router:y,store:w,render:function(t){return t(d)}}).$mount("#app")},6:function(t,e){},"6ae9":function(t,e,s){var a={"./AddContact.vue":"8fd0","./Chat.vue":"e6b0","./Chats.vue":"ac11","./Conversation.vue":"107c","./Message.vue":"0f7d","./Messages.vue":"284c"};function o(t){var e=n(t);return s(e)}function n(t){if(!s.o(a,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return a[t]}o.keys=function(){return Object.keys(a)},o.resolve=n,t.exports=o,o.id="6ae9"},"85ec":function(t,e,s){},"8fd0":function(t,e,s){"use strict";s.r(e);var a=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"add-contact"},[s("div",{staticClass:"close row middle-xs no-select"},[s("div",{staticClass:"col-xs start-xs"},[t._v(" Add Contact ")]),s("div",{staticClass:"col-xs end-xs",on:{click:t.hideWindow}},[t._v(" × ")])]),s("div",{staticClass:"no-select",staticStyle:{margin:"10px"}},[s("div",[t._v(" Show this code to the other user: ")]),s("qriously",{attrs:{value:t.personalCode,size:177}}),""==t.contactCode?s("div",{attrs:{id:"qr-window"}},[s("qrcode-stream",{on:{decode:t.onQRDecode}})],1):s("div",{staticStyle:{color:"green"}},[t._v(" Code scanned. ")]),s("input",{directives:[{name:"model",rawName:"v-model",value:t.contactName,expression:"contactName"}],class:[""==t.contactName?"red-border":"green-border"],staticStyle:{margin:"20px 0 10px 0"},attrs:{type:"text",placeholder:"Contact name"},domProps:{value:t.contactName},on:{input:function(e){e.target.composing||(t.contactName=e.target.value)}}}),s("button",{on:{click:t.addContact}},[t._v("Add Contact")])],1)])},o=[],n={data(){return{contactName:"",contactCode:"",personalCode:this.$store.state.credentials.id+"_"+this.generatePublic()}},methods:{hideWindow(){this.$store.state.addContactVisible=!1},addContact(){if(0==this.contactName.length)return;if(!this.contactCode.includes("_"))return;let t=this.contactCode.split("_")[0],e=this.generateShared(this.contactCode.split("_")[1]),s={name:this.contactName,key:e,seen:!0};this.$set(this.$store.state.contacts,t,s),this.$set(this.$store.state.chats,t,[]),this.$idbSet("contacts",this.$store.state.contacts).then(()=>{console.log("contact created..."),this.$idbSet("chats",this.$store.state.chats).then(()=>{console.log("chat created.")})}),this.hideWindow()},generatePublic(){return this.dh("3",this.$store.state.credentials.secret,this.$store.state.publicMod)},generateShared(t){return this.dh(t,this.$store.state.credentials.secret,this.$store.state.publicMod)},dh(t,e,s){let a=this.$bigInt(t),o=this.$bigInt(e),n=this.$bigInt(s);return a.modPow(o,n).toString()},onQRDecode(t){console.log(`QR code reads: ${t}`),this.contactCode=t}}},c=n,r=(s("d23d"),s("2877")),i=Object(r["a"])(c,a,o,!1,null,"25c34570",null);e["default"]=i.exports},"9b34":function(t,e,s){"use strict";var a=s("a9bc"),o=s.n(a);o.a},a5e8:function(t,e,s){"use strict";var a=s("03b3"),o=s.n(a);o.a},a9bc:function(t,e,s){},ac11:function(t,e,s){"use strict";s.r(e);var a=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"chats"},[s("div",{staticClass:"add-contact row middle-xs no-select"},[s("div",{staticClass:"col-xs-11 start-xs",on:{click:t.showWindow}},[t._v(" ✚ Add New Contact ")]),"sm"===t.$mq?s("div",{staticClass:"col-xs-1 end-xs",on:{click:t.closeWindow}},[t._v(" × ")]):t._e()]),s("div",{staticClass:"chat-items no-select"},t._l(t.$store.state.contacts,(function(e,a){return s("chat",{class:{selected:a==t.$store.state.selectedChat},attrs:{contact:a}})})),1),s("div",{staticClass:"delete-wrapper row middle-xs center-xs",on:{click:t.deleteData}},[s("div",{staticClass:"col-xs no-select"},[t._v(" Delete all data ")])])])},o=[],n={data(){return{}},methods:{showWindow(){this.$store.state.addContactVisible=!0},closeWindow(){this.$store.state.contactsVisible=!1},deleteData(){confirm("Delete all local data?")?(console.log("deleting all data"),this.$store.state.selectedChat=null,this.$store.state.contacts={},this.$store.state.chats={},this.$store.state.credentials={},this.$idbDel("contacts"),this.$idbDel("chats"),this.$idbDel("credentials")):console.log("delete canceled")}}},c=n,r=(s("9b34"),s("2877")),i=Object(r["a"])(c,a,o,!1,null,"340a07ed",null);e["default"]=i.exports},b056:function(t,e,s){"use strict";var a=s("28d6"),o=s.n(a);o.a},c669:function(t,e,s){},d23d:function(t,e,s){"use strict";var a=s("c669"),o=s.n(a);o.a},d9fa:function(t,e,s){},e6b0:function(t,e,s){"use strict";s.r(e);var a=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{directives:[{name:"long-press",rawName:"v-long-press",value:500,expression:"500"}],staticClass:"chat-item row middle-xs",on:{click:t.selectChat,dblclick:t.editContact,"long-press-start":t.deleteContact}},[s("div",{staticClass:"user col-xs-12"},[t._v(" "+t._s(t.$store.state.contacts[t.contact].name)+" ")]),0!=t.$store.state.chats[t.contact].length?s("div",{staticClass:"last-message col-xs-12",class:{unread:!t.$store.state.contacts[t.contact].seen}},[t._v(" "+t._s(t.$store.state.chats[t.contact][t.$store.state.chats[t.contact].length-1].content)+" ")]):t._e()])},o=[],n={props:["contact"],methods:{selectChat(){this.$store.state.selectedChat=this.contact,this.$store.state.contactsVisible=!1,this.$store.state.contacts[this.contact].seen=!0,this.$cookies.set("selectedChat",this.$store.state.selectedChat),this.$idbSet("contacts",this.$store.state.contacts)},editContact(){let t=prompt("Contact name:",this.$store.state.contacts[this.contact].name);null==t||""==t?console.log("rename canceled."):(this.$store.state.contacts[this.contact].name=t,this.$idbSet("contacts",this.$store.state.contacts))},deleteContact(){confirm("Delete contact: "+this.$store.state.contacts[this.contact].name+"?")?(console.log("deleting contact: "+this.$store.state.contacts[this.contact].name),this.$delete(this.$store.state.contacts,this.contact),this.$delete(this.$store.state.chats,this.contact),this.$idbSet("contacts",this.$store.state.contacts),this.$idbSet("chats",this.$store.state.chats)):console.log("delete canceled.")}}},c=n,r=(s("a5e8"),s("2877")),i=Object(r["a"])(c,a,o,!1,null,"7160ec93",null);e["default"]=i.exports}});
//# sourceMappingURL=app.1e59e515.js.map